-- -------------------------------------------
-- E-COMMERCE ORDER MANAGEMENT SQL PROJECT
-- -------------------------------------------

-- 1. Create Database
CREATE DATABASE EcommerceDB;
USE EcommerceDB;

-- 2. Create Tables

-- Customers Table
CREATE TABLE Customers (
    customer_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100),
    email VARCHAR(100),
    phone VARCHAR(15),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Products Table
CREATE TABLE Products (
    product_id INT PRIMARY KEY AUTO_INCREMENT,
    product_name VARCHAR(100),
    price DECIMAL(10,2),
    stock INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Orders Table
CREATE TABLE Orders (
    order_id INT PRIMARY KEY AUTO_INCREMENT,
    customer_id INT,
    order_date DATE,
    status VARCHAR(20),
    FOREIGN KEY (customer_id) REFERENCES Customers(customer_id)
);

-- Order Details Table
CREATE TABLE OrderDetails (
    order_detail_id INT PRIMARY KEY AUTO_INCREMENT,
    order_id INT,
    product_id INT,
    quantity INT,
    total_price DECIMAL(10,2),
    FOREIGN KEY (order_id) REFERENCES Orders(order_id),
    FOREIGN KEY (product_id) REFERENCES Products(product_id)
);

-- 3. Insert Sample Data

INSERT INTO Customers (name, email, phone) VALUES
('Arjun Patel', 'arjun@example.com', '9876543210'),
('Meera Raj', 'meera@example.com', '9988776655'),
('Kiran Rao', 'kiran@example.com', '9123456780');

INSERT INTO Products (product_name, price, stock) VALUES
('Laptop', 55000, 20),
('Smartphone', 25000, 40),
('Headphones', 1500, 100),
('Keyboard', 900, 60);

INSERT INTO Orders (customer_id, order_date, status) VALUES
(1, '2025-02-10', 'Pending'),
(2, '2025-02-11', 'Completed'),
(3, '2025-02-12', 'Pending');

INSERT INTO OrderDetails (order_id, product_id, quantity, total_price) VALUES
(1, 1, 1, 55000),
(1, 3, 2, 3000),
(2, 2, 1, 25000),
(3, 4, 3, 2700);

-- 4. Basic Select Queries

-- View all customers
SELECT * FROM Customers;

-- View all products
SELECT * FROM Products;

-- View complete order details with customer name & product name
SELECT 
    O.order_id,
    C.name AS customer,
    P.product_name,
    OD.quantity,
    OD.total_price,
    O.status
FROM OrderDetails OD
JOIN Orders O ON OD.order_id = O.order_id
JOIN Customers C ON O.customer_id = C.customer_id
JOIN Products P ON OD.product_id = P.product_id;

-- 5. Update Stock After Order
UPDATE Products
SET stock = stock - 2
WHERE product_id = 3;

-- 6. Delete Customer
DELETE FROM Customers
WHERE customer_id = 3;

-- 7. Create a View for Order Summary
CREATE VIEW OrderSummary AS
SELECT
    O.order_id,
    C.name AS customer_name,
    O.order_date,
    O.status,
    SUM(OD.total_price) AS order_total
FROM Orders O
JOIN Customers C ON O.customer_id = C.customer_id
JOIN OrderDetails OD ON O.order_id = OD.order_id
GROUP BY O.order_id;

SELECT * FROM OrderSummary;

-- 8. Stored Procedure: Get Orders for a Customer
DELIMITER //
CREATE PROCEDURE GetCustomerOrders(IN cust_id INT)
BEGIN
    SELECT 
        O.order_id,
        O.order_date,
        O.status,
        SUM(OD.total_price) AS total_amount
    FROM Orders O
    JOIN OrderDetails OD ON O.order_id = OD.order_id
    WHERE O.customer_id = cust_id
    GROUP BY O.order_id;
END//
DELIMITER ;

CALL GetCustomerOrders(1);

-- 9. Trigger: Reduce Stock Automatically After Inserting Order
DELIMITER //
CREATE TRIGGER ReduceStock
AFTER INSERT ON OrderDetails
FOR EACH ROW
BEGIN
    UPDATE Products
    SET stock = stock - NEW.quantity
    WHERE product_id = NEW.product_id;
END//
DELIMITER ;
